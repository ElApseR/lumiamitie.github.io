<!DOCTYPE html>
<html>
<!--
====================================================
    __  ____  ______________  _______ ___    __ 
   / / / /  |/  / ____/   \ \/ / ___//   |  / / 
  / /_/ / /|_/ / /_  / /| |\  /\__ \/ /| | / /  
 / __  / /  / / __/ / ___ |/ /___/ / ___ |/ /___
/_/ /_/_/  /_/_/   /_/  |_/_//____/_/  |_/_____/
                                                     
====================================================
Author: Hossain Mohammad Faysal
Profile: https://www.facebook.com/hmfaysal
Version: 1.0
Description: Awesome dude, awesome life
====================================================
-->
<head>
<meta charset="utf-8">
<title>MCMC FOR DUMMIES IN R</title>
<meta name="description" content="Data and Visualization">
<meta name="keywords" content="r, mcmc, sampling">



<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="MCMC for dummies in r">
<meta property="og:description" content="Data and Visualization">
<meta property="og:url" content="http://lumiamitie.github.io/r/mcmc-for-dummies">
<meta property="og:site_name" content="lmnsh">
<meta property="og:image" content="http://lumiamitie.github.io/images/">





<link rel="canonical" href="http://lumiamitie.github.io/r/mcmc-for-dummies">
<link href="http://lumiamitie.github.io/feed.xml" type="application/atom+xml" rel="alternate" title="lmnsh Feed">


<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />


    <link href='http://fonts.googleapis.com/css?family=Montserrat:400,700&amp;subset=latin,latin-ext' rel='stylesheet'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,300,700,800,600&amp;subset=latin,latin-ext' rel='stylesheet'>
    <link rel="stylesheet" href="http://lumiamitie.github.io/assets/css/font-awesome.min.css">
    <link rel="stylesheet" href="http://lumiamitie.github.io/assets/css/vendor/normalizeb146.css?v=77a7756db2">
    <link rel="stylesheet" href="http://lumiamitie.github.io/assets/css/vendor/foundation.minb146.css?v=77a7756db2">
    <link rel="stylesheet" href="http://lumiamitie.github.io/assets/css/styleb146.css?v=77a7756db2">
    <link rel="stylesheet" href="http://lumiamitie.github.io/assets/css/postb146.css?v=77a7756db2">
    <script src="http://lumiamitie.github.io/assets/js/vendor/modernizrb146.js?v=77a7756db2"></script>





<!-- Icons -->
<!-- 16x16 -->
    <!--
<link rel="shortcut icon" href="http://lumiamitie.github.io/favicon.ico">
    -->
<!-- 32x32 -->
<link rel="shortcut icon" href="http://lumiamitie.github.io/favicon.png">
    
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://lumiamitie.github.io/images/bloglogo57.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://lumiamitie.github.io/images/bloglogo72.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://lumiamitie.github.io/images/bloglogo114.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://lumiamitie.github.io/images/bloglogo144.png">

</head>
<body class="post-template" itemscope itemtype="http://schema.org/WebPage">  

<main id="summer-post-container" class="summer-post-container intro-effect-sliced" role="main">
    
    
        <header class="summer-post-header">
            <div class="bg-img"></div>
            
            <div class="summer-post-menu-header">
                
                    <a class="summer-blog-logo" href="http://lumiamitie.github.io">
                        <img src="http://lumiamitie.github.io/images/bloglogo150.png" alt="Blog Logo" />
                    </a>
                
                
                
                <div class="summer-blog-menu">      
    <div class="summer-mobile-menu show-for-small">
        <a href="#"><i class="fa fa-bars"></i></a>
    </div>
    <ul class="summer-menu">
        <li class="summer-mobile-close-btn show-for-small text-right">
            <a href="#"><i class="fa fa-times"></i></a>
        </li>

            <li>
                    <a href="http://lumiamitie.github.io/">Home</a>
                 </li>

            <li>
                    <a href="http://lumiamitie.github.io/featured">Featured Posts</a>
                 </li>

            <li>
                    <a href="http://lumiamitie.github.io/categories">Categories</a>
                 </li>

            <li>
                    <a href="http://lumiamitie.github.io/mino">About</a>
                 </li>
            
           <li><a href="http://lumiamitie.github.io/feed.xml" title="Atom/RSS feed"><i class="icon-rss"></i> Feed</a></li>
    </ul>

</div>
            </div>
            <div class="summer-post-title bg-check">
                <h1>MCMC for dummies in r</h1>
                <p>by <strong>Minho Lee</strong> &#8212; on <a href="http://lumiamitie.github.io/tags/index.html#r" data-toggle="tooltip" title="Posts tagged with r" rel="tag">r</a>&nbsp;&comma;&nbsp;<a href="http://lumiamitie.github.io/tags/index.html#mcmc" data-toggle="tooltip" title="Posts tagged with mcmc" rel="tag">mcmc</a>&nbsp;&comma;&nbsp;<a href="http://lumiamitie.github.io/tags/index.html#sampling" data-toggle="tooltip" title="Posts tagged with sampling" rel="tag">sampling</a> <strong><time datetime="2016-05-10T00:00:00+09:00">10 May 2016</time></strong></p>
            </div>
            <div class="bg-img"></div>
        </header>
        <button class="trigger bg-check" data-info="Read more"><span>Trigger</span></button>
        
        <article class="summer-post-content post">
            <div><p><img src="/images/rocks-waves.jpg" alt="cover-image"></p>

<h1 id="mcmc-for-dummies">MCMC for dummies</h1>

<p>학부 확률과정론 시간에 교수님께서 MCMC를 열성적으로 강의하셨지만 학생들이 너무 멘붕에 빠져서 결국 시험범위에서는 제외되었던 기억이 난다. 그것이 mcmc에 대한 첫 인상이었는데, 졸업까지 총 세 과목에서 공부했지만 제대로 공부하지 않고 항상 피해다니려고만 했다. 그리고 결국 다시 공부를 해야하지 않을까 하는 생각이 마구마구 든다. 이럴거면 미리 잘 해둘걸&hellip;.</p>

<p>아무래도 수식보다는 절차가 잘 설명되어있는 코드를 직접 돌려보면서 공부하는 것이 좋을 것 같아서 관련 글을 검색해보기 시작했다. 그러다 찾아낸 <a href="http://twiecki.github.io/blog/2015/11/10/mcmc-sampling/">http://twiecki.github.io/blog/2015/11/10/mcmc-sampling/</a> 을 보고 해당 글의 내용을 R로 옮겨서 작성해봐야겠다는 생각이 들었다. 포스팅 후반부의 시각화 부분은 제외하고 mcmc 샘플링 함수를 구성하는 과정까지만 옮겨보았다. R코드 위주로만 정리했기 때문에 MCMC에 대한 구체적인 내용을 살펴보고 싶다면 원본 게시물과 다른 자료들을 참고하시길!</p>
<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="kn">library</span><span class="p">(</span>ggplot2<span class="p">)</span>
<span class="kn">library</span><span class="p">(</span>dplyr<span class="p">)</span>
</code></pre></div>
<p><br />
<br /></p>

<h2 id="1-데이터-생성">1. 데이터 생성</h2>

<p>표준 정규분포를 따르는 변수 100개를 생성한다</p>
<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="kp">set.seed</span><span class="p">(</span><span class="m">123</span><span class="p">)</span>
data <span class="o">=</span> rnorm<span class="p">(</span><span class="m">100</span><span class="p">)</span>
df_data <span class="o">=</span> <span class="kt">data.frame</span><span class="p">(</span>x <span class="o">=</span> data<span class="p">)</span>
</code></pre></div>
<p><br /></p>

<p>생성한 데이터의 분포를 히스토그램을 통해 확인해보자</p>
<div class="highlight"><pre><code class="language-r" data-lang="r">df_data <span class="o">%&gt;%</span> 
  ggplot<span class="p">(</span>aes<span class="p">(</span>x <span class="o">=</span> data<span class="p">))</span> <span class="o">+</span>
    geom_histogram<span class="p">(</span>bins <span class="o">=</span> <span class="m">8</span><span class="p">,</span> fill<span class="o">=</span><span class="s">&#39;steelblue&#39;</span><span class="p">)</span> <span class="o">+</span>
    xlim<span class="p">(</span><span class="m">-3</span><span class="p">,</span> <span class="m">3</span><span class="p">)</span> <span class="o">+</span>
    ggtitle<span class="p">(</span><span class="s">&#39;Histogram of observed data&#39;</span><span class="p">)</span>
</code></pre></div>
<p><img src="/images/post_image/mcmc_for_dummies/unnamed-chunk-3-1.png" alt=""></p>

<p>이제 평균의 posterior분포를 찾아보자. 표준편차는 1이라는 것을 알고있다고 가정한다</p>

<p>우선 이론적으로 prior가 정규분포일때의 posterior는 동일하게 정규분포를 따른다</p>

<p><a href="https://en.wikipedia.org/wiki/Conjugate_prior">https://en.wikipedia.org/wiki/Conjugate_prior</a> 에서 <em>Normal with known variance의 Posterior hyperparameters</em>를 참고하여 함수를 작성한다 </p>
<div class="highlight"><pre><code class="language-r" data-lang="r">calc_post_analytical <span class="o">=</span> <span class="kr">function</span><span class="p">(</span>data<span class="p">,</span> x<span class="p">,</span> mu_0<span class="p">,</span> sigma_0<span class="p">){</span>
  sigma <span class="o">=</span> <span class="m">1</span>
  n <span class="o">=</span> <span class="kp">length</span><span class="p">(</span>data<span class="p">)</span>

  mu_post_u <span class="o">=</span> mu_0 <span class="o">/</span> <span class="p">(</span>sigma_0<span class="o">^</span><span class="m">2</span><span class="p">)</span> <span class="o">+</span> <span class="kp">sum</span><span class="p">(</span>x<span class="p">)</span> <span class="o">/</span> <span class="p">(</span>sigma<span class="o">^</span><span class="m">2</span><span class="p">)</span>
  mu_post_l <span class="o">=</span> <span class="p">(</span><span class="m">1</span> <span class="o">/</span> <span class="p">(</span>sigma_0<span class="p">)</span><span class="o">^</span><span class="m">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span>n <span class="o">/</span> <span class="p">(</span>sigma<span class="o">^</span><span class="m">2</span><span class="p">))</span>

  <span class="c1"># posterior mean, sigma</span>
  mu_post <span class="o">=</span> mu_post_u <span class="o">/</span> mu_post_l
  sigma_post <span class="o">=</span> mu_post_l <span class="o">^</span> <span class="p">(</span><span class="m">-1</span><span class="o">/</span><span class="m">2</span><span class="p">)</span>

  <span class="c1"># (Analytical) posterior density plot</span>
  post_x <span class="o">=</span> x
  post_y <span class="o">=</span> dnorm<span class="p">(</span>post_x<span class="p">,</span> mu_post<span class="p">,</span> sigma_post<span class="p">)</span>
  post_df <span class="o">=</span> <span class="kt">data.frame</span><span class="p">(</span>
    x <span class="o">=</span> post_x<span class="p">,</span>
    y <span class="o">=</span> post_y
  <span class="p">)</span>

  result <span class="o">=</span> <span class="kt">list</span><span class="p">(</span>
    <span class="c1"># posterior parameter</span>
    param <span class="o">=</span> <span class="kt">c</span><span class="p">(</span>mu_post<span class="p">,</span> sigma_post<span class="p">),</span> 
    <span class="c1"># sample data for posterior pdf</span>
    post_data <span class="o">=</span> post_df<span class="p">,</span>
    <span class="c1"># posterior pdf by ggplot2</span>
    pdf <span class="o">=</span> ggplot<span class="p">(</span>post_df<span class="p">,</span> aes<span class="p">(</span>x<span class="o">=</span>x<span class="p">,</span> y<span class="o">=</span>y<span class="p">))</span> <span class="o">+</span> 
      geom_line<span class="p">(</span>colour <span class="o">=</span> <span class="s">&#39;steelblue&#39;</span><span class="p">)</span> <span class="o">+</span>
      ggtitle<span class="p">(</span><span class="s">&#39;Analytical Posterior&#39;</span><span class="p">)</span>
    <span class="p">)</span>
  <span class="c1"># add names to result$param</span>
  <span class="kp">names</span><span class="p">(</span>result<span class="o">$</span>param<span class="p">)</span> <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="s">&#39;mu_post&#39;</span><span class="p">,</span> <span class="s">&#39;sigma_post&#39;</span><span class="p">)</span>

  <span class="kr">return</span><span class="p">(</span>result<span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<hr>

<p><br />
<br /></p>

<p>이제 위에서 생성했던 데이터를 바탕으로 이론적인 posterior를 구할 수 있다</p>
<div class="highlight"><pre><code class="language-r" data-lang="r">post_analytical <span class="o">=</span> calc_post_analytical<span class="p">(</span>data<span class="p">,</span> <span class="kp">seq</span><span class="p">(</span><span class="m">-1</span><span class="p">,</span><span class="m">1</span><span class="p">,</span> length.out <span class="o">=</span> <span class="m">500</span><span class="p">),</span> <span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span>
</code></pre></div>
<p><code>calc_post_analytical</code>함수의 결과물은 세 가지 항목을 가진다.</p>

<ul>
<li>Posterior의 평균과 표준편차</li>
<li>posterior 분포 데이터</li>
<li>posterior 분포의 ggplot2 그래프</li>
</ul>
<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># mu_post , sigma_post</span>
post_analytical<span class="o">$</span>param
</code></pre></div><div class="highlight"><pre><code class="language-text" data-lang="text">##       mu_post    sigma_post 
## -4.012192e-16  9.950372e-02
</code></pre></div><div class="highlight"><pre><code class="language-r" data-lang="r"><span class="kp">head</span><span class="p">(</span>post_analytical<span class="o">$</span>post_data<span class="p">)</span>
</code></pre></div><div class="highlight"><pre><code class="language-text" data-lang="text">##            x            y
## 1 -1.0000000 4.690287e-22
## 2 -0.9959920 7.025119e-22
## 3 -0.9919840 1.050518e-21
## 4 -0.9879760 1.568369e-21
## 5 -0.9839679 2.337699e-21
## 6 -0.9799599 3.478759e-21
</code></pre></div><div class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># Analytical Posterior</span>
post_analytical<span class="o">$</span>pdf
</code></pre></div>
<p><img src="/images/post_image/mcmc_for_dummies/unnamed-chunk-8-1.png" alt=""></p>

<hr>

<p><br />
<br /></p>

<h2 id="2-mcmc-sampling">2. MCMC Sampling</h2>

<p>MCMC를 통해 샘플링하는 과정을 단계별로 나누어서 살펴보자.</p>

<hr>

<p><br /></p>

<h3 id="1-set-starting-position">1 Set starting position</h3>

<p>MCMC sampling을 진행하려면 먼저 초기값을 설정해야 한다. 여기서 초기값은 임의의 값으로 두어도 괜찮다. 일단은 값을 1로 두고 시작해보자</p>
<div class="highlight"><pre><code class="language-r" data-lang="r">mu_current <span class="o">=</span> <span class="m">1</span>
</code></pre></div>
<hr>

<p><br /></p>

<h3 id="2-make-proposal">2 Make Proposal</h3>

<p>이제 기존에 있던 위치에서 다른 곳으로 옮겨갈수도 있다. 현재 mu값(<code>mu_current</code>)을 중심으로 하는 정규분포를 가정하고 옮겨갈 위치를 제안할 수 있다. 이 때 표준편차는 <code>proposal_width</code>라는 변수로 정의해서 이동 범위를 정할 수 있다</p>
<div class="highlight"><pre><code class="language-r" data-lang="r">proposal_width <span class="o">=</span> <span class="m">0.5</span>
<span class="kp">set.seed</span><span class="p">(</span><span class="m">123</span><span class="p">)</span>
mu_proposal <span class="o">=</span> rnorm<span class="p">(</span><span class="m">1</span><span class="p">,</span> mu_current<span class="p">,</span> proposal_width<span class="p">)</span>
</code></pre></div>
<p><br/></p>

<p>이번에는 제안한 지점이 옮겨갈만한 곳인지 판단해야 한다. 새로 제안한 mu값을 바탕으로 한 분포가 기존 분포보다 데이터를 더 잘 설명한다면, 옮겨가도 좋을 것이다. 현재 지점과 옮겨갈 지점의 prior probability와 likelihood를 구하고 두 값을 곱해서 비교한다(Bayes정리의 분자 부분)</p>
<div class="highlight"><pre><code class="language-r" data-lang="r">likelihood_current <span class="o">=</span> dnorm<span class="p">(</span>data<span class="p">,</span> mu_current<span class="p">,</span> <span class="m">1</span><span class="p">)</span>
likelihood_proposal <span class="o">=</span> dnorm<span class="p">(</span>data<span class="p">,</span> mu_proposal<span class="p">,</span> <span class="m">1</span><span class="p">)</span>

mu_prior_mu <span class="o">=</span> <span class="m">0</span>
mu_prior_sd <span class="o">=</span> <span class="m">1</span>
prior_current <span class="o">=</span> dnorm<span class="p">(</span>mu_current<span class="p">,</span> mu_prior_mu<span class="p">,</span> mu_prior_sd<span class="p">)</span>
prior_proposal <span class="o">=</span> dnorm<span class="p">(</span>mu_proposal<span class="p">,</span> mu_prior_mu<span class="p">,</span> mu_prior_sd<span class="p">)</span>

<span class="c1"># Bayes정리의 분자부분</span>
p_current <span class="o">=</span> prior_current <span class="o">*</span> <span class="kp">prod</span><span class="p">(</span>likelihood_current<span class="p">)</span>
p_proposal <span class="o">=</span> prior_proposal <span class="o">*</span> <span class="kp">prod</span><span class="p">(</span>likelihood_proposal<span class="p">)</span>
</code></pre></div>
<hr>

<p><br /></p>

<h3 id="3-accept-reject-the-proposal">3 Accept / Reject the proposal</h3>

<p>이제 두 값을 나눈다!</p>
<div class="highlight"><pre><code class="language-r" data-lang="r">p_accept <span class="o">=</span> p_proposal <span class="o">/</span> p_current
</code></pre></div>
<p><br /></p>

<p>0부터 1사이의 값을 가지는 난수를 하나 발생시키고 <code>p_accept</code>값과 비교한다. 따라서 <code>p_proposal</code>이 <code>p_current</code>보다 값이 큰 경우에는 제안이 무조건 받아들여진다. 현재 parameter의 확률이 더 높은 경우에는 일정 확률로 제안을 받아들인다. </p>
<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="kp">set.seed</span><span class="p">(</span><span class="m">123</span><span class="p">)</span>
accept <span class="o">=</span> runif<span class="p">(</span><span class="m">1</span><span class="p">)</span> <span class="o">&lt;</span> p_accept
</code></pre></div>
<p>제안을 받아들이는 경우 해당 값을 현재 값으로 변경한다. 그리고 이 과정을 반복한다</p>
<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="kr">if</span><span class="p">(</span>accept<span class="p">){</span>
  mu_current <span class="o">=</span> mu_proposal
<span class="p">}</span>
</code></pre></div>
<hr>

<p><br /></p>

<p>이러한 과정을 통해 Posterior 분포에 대한 샘플링 결과물을 얻을 수 있다. 샘플링 과정을 하나의 함수로 구성해보자</p>
<div class="highlight"><pre><code class="language-r" data-lang="r">sampler <span class="o">=</span> <span class="kr">function</span><span class="p">(</span>data<span class="p">,</span> n_sample <span class="o">=</span> <span class="m">4</span><span class="p">,</span> mu_init <span class="o">=</span> <span class="m">0.5</span><span class="p">,</span> proposal_width <span class="o">=</span> <span class="m">0.5</span><span class="p">,</span>
                   mu_prior_mu <span class="o">=</span> <span class="m">0</span><span class="p">,</span> mu_prior_sd <span class="o">=</span> <span class="m">1</span><span class="p">,</span> seed <span class="o">=</span> <span class="kc">NA</span><span class="p">){</span>

  <span class="c1"># 난수의 seed값이 필요하다면 여기서 지정한다</span>
  <span class="kr">if</span><span class="p">(</span><span class="o">!</span><span class="kp">is.na</span><span class="p">(</span>seed<span class="p">)){</span>
    <span class="kp">set.seed</span><span class="p">(</span>seed<span class="p">)</span>
  <span class="p">}</span>

  <span class="c1"># 초기값을 설정한다</span>
  mu_current <span class="o">=</span> mu_init
  posterior_result <span class="o">=</span> <span class="kt">data.frame</span><span class="p">(</span>posterior <span class="o">=</span> mu_current<span class="p">,</span>
                                mu_current <span class="o">=</span> mu_current<span class="p">,</span>
                                mu_proposal <span class="o">=</span> <span class="kc">NA</span><span class="p">,</span>
                                p_current <span class="o">=</span> <span class="kc">NA</span><span class="p">,</span>
                                p_proposal <span class="o">=</span> <span class="kc">NA</span><span class="p">,</span>
                                accept <span class="o">=</span> <span class="kc">NA</span><span class="p">)</span>

  <span class="kr">for</span><span class="p">(</span>idx <span class="kr">in</span> <span class="m">1</span><span class="o">:</span>n_sample<span class="p">){</span>
    <span class="c1"># 새로운 mu값을 제안한다</span>
    mu_proposal <span class="o">=</span> rnorm<span class="p">(</span><span class="m">1</span><span class="p">,</span> mu_current<span class="p">,</span> proposal_width<span class="p">)</span>

    <span class="c1"># 각 mu별로 likelihood를 계산한다</span>
    likelihood_current <span class="o">=</span> dnorm<span class="p">(</span>data<span class="p">,</span> mu_current<span class="p">,</span> <span class="m">1</span><span class="p">)</span>
    likelihood_proposal <span class="o">=</span> dnorm<span class="p">(</span>data<span class="p">,</span> mu_proposal<span class="p">,</span> <span class="m">1</span><span class="p">)</span>

    <span class="c1"># prior probability를 계산한다</span>
    mu_prior_mu <span class="o">=</span> <span class="m">0</span>
    mu_prior_sd <span class="o">=</span> <span class="m">1</span>
    prior_current <span class="o">=</span> dnorm<span class="p">(</span>mu_current<span class="p">,</span> mu_prior_mu<span class="p">,</span> mu_prior_sd<span class="p">)</span>
    prior_proposal <span class="o">=</span> dnorm<span class="p">(</span>mu_proposal<span class="p">,</span> mu_prior_mu<span class="p">,</span> mu_prior_sd<span class="p">)</span>

    <span class="c1"># 두 가지 값을 곱한다 (베이즈 정리의 분자값)</span>
    p_current <span class="o">=</span> prior_current <span class="o">*</span> <span class="kp">prod</span><span class="p">(</span>likelihood_current<span class="p">)</span>
    p_proposal <span class="o">=</span> prior_proposal <span class="o">*</span> <span class="kp">prod</span><span class="p">(</span>likelihood_proposal<span class="p">)</span>

    <span class="c1"># 새로 제안한 값의 확률이 더 크다면 바로 채택</span>
    <span class="c1"># 기존 값의 확률이 더 크다면 난수를 하나 더 뽑아서 해당 값보다 높으면 채택</span>
    p_accept <span class="o">=</span> p_proposal <span class="o">/</span> p_current
    accept <span class="o">=</span> runif<span class="p">(</span><span class="m">1</span><span class="p">)</span> <span class="o">&lt;</span> p_accept

    <span class="c1"># 채택되었다면 해당 값을 mu_current로 설정하고 이 과정을 반복한다</span>
    <span class="kr">if</span><span class="p">(</span>accept<span class="p">){</span>
      proposal_df <span class="o">=</span> <span class="kt">data.frame</span><span class="p">(</span>posterior <span class="o">=</span> mu_proposal<span class="p">,</span>
                               mu_current <span class="o">=</span> mu_current<span class="p">,</span>
                               mu_proposal <span class="o">=</span> mu_proposal<span class="p">,</span>
                               p_current <span class="o">=</span> p_current<span class="p">,</span>
                               p_proposal <span class="o">=</span> p_proposal<span class="p">,</span>
                               accept <span class="o">=</span> accept<span class="p">)</span>
      mu_current <span class="o">=</span> mu_proposal
    <span class="p">}</span> <span class="kr">else</span> <span class="p">{</span>
      proposal_df <span class="o">=</span> <span class="kt">data.frame</span><span class="p">(</span>posterior <span class="o">=</span> mu_current<span class="p">,</span>
                               mu_current <span class="o">=</span> mu_current<span class="p">,</span>
                               mu_proposal <span class="o">=</span> mu_proposal<span class="p">,</span>
                               p_current <span class="o">=</span> p_current<span class="p">,</span>
                               p_proposal <span class="o">=</span> p_proposal<span class="p">,</span>
                               accept <span class="o">=</span> accept<span class="p">)</span>
    <span class="p">}</span>

    posterior_result <span class="o">=</span> <span class="kp">rbind</span><span class="p">(</span>posterior_result<span class="p">,</span> proposal_df<span class="p">)</span>
  <span class="p">}</span>

  <span class="kr">return</span><span class="p">(</span>posterior_result<span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<hr>

<p><br /></p>

<p>샘플링 결과물을 확인해보자</p>
<div class="highlight"><pre><code class="language-r" data-lang="r">mcmc_result <span class="o">=</span> sampler<span class="p">(</span>data<span class="p">,</span> n_sample <span class="o">=</span> <span class="m">5000</span><span class="p">,</span> seed <span class="o">=</span> <span class="m">123</span><span class="p">)</span>
<span class="kp">head</span><span class="p">(</span>mcmc_result<span class="p">,</span> n<span class="o">=</span><span class="m">10</span><span class="p">)</span>
</code></pre></div><div class="highlight"><pre><code class="language-text" data-lang="text">##     posterior mu_current mu_proposal    p_current   p_proposal accept
## 1   0.5000000  0.5000000          NA           NA           NA     NA
## 2   0.2197622  0.5000000   0.2197622 1.208153e-62 2.544422e-59   TRUE
## 3   0.2197622  0.2197622   0.8148655 2.544422e-59 1.731611e-70  FALSE
## 4   0.2550164  0.2197622   0.2550164 2.544422e-59 1.502840e-59   TRUE
## 5   0.2005334  0.2550164   0.2005334 1.502840e-59 3.216178e-59   TRUE
## 6   0.2005334  0.2005334   0.4309915 3.216178e-59 1.660419e-61  FALSE
## 7   0.2005334  0.2005334   0.8408108 3.216178e-59 2.501439e-71  FALSE
## 8  -0.0222976  0.2005334  -0.0222976 3.216178e-59 3.187863e-59   TRUE
## 9  -0.0222976 -0.0222976   0.2296086 3.187863e-59 2.224370e-59  FALSE
## 10  0.1780881 -0.0222976   0.1780881 3.187863e-59 4.032705e-59   TRUE
</code></pre></div>
<p>샘플링 결과물의 trace는 아래와 같이 확인할 수 있다</p>
<div class="highlight"><pre><code class="language-r" data-lang="r">mcmc_result <span class="o">%&gt;%</span> 
  mutate<span class="p">(</span>idx <span class="o">=</span> row_number<span class="p">())</span> <span class="o">%&gt;%</span> 
  ggplot<span class="p">(</span>aes<span class="p">(</span>x<span class="o">=</span>idx<span class="p">,</span> y<span class="o">=</span>posterior<span class="p">))</span><span class="o">+</span>
    geom_line<span class="p">(</span>colour <span class="o">=</span> <span class="s">&#39;steelblue&#39;</span><span class="p">)</span> <span class="o">+</span>
    ggtitle<span class="p">(</span><span class="s">&#39;Trace of posterior samples&#39;</span><span class="p">)</span>
</code></pre></div>
<p><img src="/images/post_image/mcmc_for_dummies/unnamed-chunk-17-1.png" alt=""></p>

<p>초기값은 0.5였지만 점차 0 ~ 0.2 사이의 값으로 안정화되는 모습을 보인다</p>

<hr>

<p>posterior mu 값의 분포를 구하고 위에서 구했던 이론적인 값의 분포와 비교해보자. 그래프에서 점선으로 표시된 분포가 이론적인 계산을 통해 구한 posterior 분포이다.</p>
<div class="highlight"><pre><code class="language-r" data-lang="r">mcmc_result<span class="p">[</span><span class="m">3001</span><span class="o">:</span><span class="m">5000</span><span class="p">,]</span> <span class="o">%&gt;%</span> 
  ggplot<span class="p">(</span>aes<span class="p">(</span>x <span class="o">=</span> posterior<span class="p">))</span> <span class="o">+</span>
    geom_density<span class="p">(</span>fill<span class="o">=</span> <span class="s">&#39;steelblue&#39;</span><span class="p">,</span> alpha <span class="o">=</span> <span class="m">0.5</span><span class="p">)</span> <span class="o">+</span>
    geom_line<span class="p">(</span>data <span class="o">=</span> post_analytical<span class="o">$</span>post_data<span class="p">,</span> 
              aes<span class="p">(</span>x<span class="o">=</span>x<span class="p">,</span> y<span class="o">=</span>y<span class="p">),</span>
              linetype <span class="o">=</span> <span class="m">2</span><span class="p">)</span> <span class="o">+</span>
    xlim<span class="p">(</span><span class="m">-0.5</span><span class="p">,</span> <span class="m">0.5</span><span class="p">)</span> <span class="o">+</span>
    ggtitle<span class="p">(</span><span class="s">&#39;Density of Posterior Distribution&#39;</span><span class="p">)</span>
</code></pre></div>
<p><img src="/images/post_image/mcmc_for_dummies/unnamed-chunk-18-1.png" alt=""></p>

            </div>
        </article>
        <div class="cf"></div>
        <div class="row text-center">
            <section class="summer-post-share">
                <a class="twitter-icon" href="https://twitter.com/intent/tweet?text=&quot;MCMC for dummies in r&quot;%20http://lumiamitie.github.io/r/mcmc-for-dummies%20via%20&#64;"
                    onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" title="Share on Twitter">
                    <i class="fa fa-twitter"></i>
                </a>
                <a class="facebook-icon" href="https://www.facebook.com/sharer/sharer.php?u=http://lumiamitie.github.io/r/mcmc-for-dummies"
                    onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;" title="Share on Facebook">
                    <i class="fa fa-facebook"></i>
                </a>
                <a class="google-icon" href="https://plus.google.com/share?url=http://lumiamitie.github.io/r/mcmc-for-dummies"
                   onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;" title="Share on Google+">
                    <i class="fa fa-google-plus"></i>
                </a>
            </section>
        </div>
        <div class="cf"></div>
        
            <div class="summer-author-info">
                <div class="row">
                    <section class="summer-post-author small-12 columns">
                        
                            <img src="http://lumiamitie.github.io/images/mino.jpg" class="summer-post-author-avatar" alt="Minho Lee's photo">
                        
                        
                            <span class="author-label">Author</span>
                            <h1>Minho Lee</h1>
                        
                        
                            <p><a href="mailto:lumiamitie@email.com" class="author-website">lumiamitie@email.com</a></p>
                        
                        
                            <p>Mind the Gap!</p>
                        
                    </section>
                </div>
            </div> 
        
        <div class="cf"></div>
        
        <section class="summer-disqus row">
    <div class="small-12 columns">
        <h1 class="summer-comments-header">Comments</h1>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'lumiamitie'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>
</section>

        <div class="cf"></div>

    <footer class="summer-site-footer">
    <div class="copyright">
         <section>All content copyright <a href="http://lumiamitie.github.io">Minho Lee</a> &copy; 2017 &bull; All rights reserved.</section>
         <section>Proudly published with <a class="icon-ghost" href="https://jekyllrb.com/">Jekyll</a></section>
    </div>
    <div class="social-icons">
        
        
        
        
        <a href="http://instagram.com/lmnsh_">
            <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x fa-inverse"></i>
                <i class="fa fa-instagram fa-stack-1x"></i>
            </span>
        </a>
        
        
        <a href="http://github.com/lumiamitie">
            <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x fa-inverse"></i>
                <i class="fa fa-github fa-stack-1x"></i>
            </span>
        </a>
        
        
    </div>
    
    <div class="cf"></div>
</footer> 
</main>    
    <script src="http://lumiamitie.github.io/assets/js/public/jqueryb146.js?v=77a7756db2"></script>

    
    <script src="http://lumiamitie.github.io/assets/js/vendor/fastclickb146.js?v=77a7756db2"></script>
    <script src="http://lumiamitie.github.io/assets/js/vendor/foundation.minb146.js?v=77a7756db2"></script>
    <script src="http://lumiamitie.github.io/assets/js/vendor/background-checkb146.js?v=77a7756db2"></script>
    <script src="http://lumiamitie.github.io/assets/js/vendor/post-header-animationsb146.js?v=77a7756db2"></script>
    <script src="http://lumiamitie.github.io/assets/js/summerb146.js?v=77a7756db2"></script>

	<link rel="stylesheet" href="http://lumiamitie.github.io/assets/highlight/default.css">
	<script src="http://lumiamitie.github.io/assets/highlight/highlight.pack.js"></script>
	<script>hljs.initHighlightingOnLoad();</script>
	

<!-- Asynchronous Google Analytics snippet -->
<script>
/*
  var _gaq = _gaq || [];
  var pluginUrl = 
 '//www.google-analytics.com/plugins/ga/inpage_linkid.js';
  _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
  _gaq.push(['_setAccount', 'UA-69341391-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
*/
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-69341391-1', 'auto');
  ga('send', 'pageview');

</script>
 
</body>
</html>
